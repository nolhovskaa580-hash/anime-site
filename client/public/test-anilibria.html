<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç AniLiberty API + HLS Video Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .section {
            background: #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .video-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            margin: 20px 0;
        }
        
        video {
            width: 100%;
            height: 100%;
        }
        
        button {
            background: #FF6B6B;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #ff5252;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .info {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .success {
            background: #4CAF50;
            color: white;
        }
        
        .error {
            background: #f44336;
            color: white;
        }
        
        .loading {
            background: #2196F3;
            color: white;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç AniLiberty API + HLS Video Player</h1>
        
        <div class="section">
            <h3>üì° API –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <button onclick="testAPI()">–¢–µ—Å—Ç API</button>
            <button onclick="loadVideo()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–∏–¥–µ–æ</button>
            <button onclick="testHLS()">–¢–µ—Å—Ç HLS –ø–ª–µ–µ—Ä–∞</button>
            <div id="api-status"></div>
            <div id="api-info"></div>
        </div>
        
        <div class="section">
            <h3>üé¨ HLS Video Player</h3>
            <div class="video-container">
                <video id="video" controls muted autoplay playsinline></video>
            </div>
            <div id="video-info"></div>
        </div>
        
        <div class="section">
            <h3>üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
            <div class="info" id="tech-info"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://aniliberty.top/api/v1';
        let currentVideoData = null;
        let hls = null;
        
        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        function updateInfo(elementId, data) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="info">${JSON.stringify(data, null, 2)}</div>`;
        }
        
        async function testAPI() {
            updateStatus('api-status', '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API...', 'loading');
            
            try {
                const response = await fetch(`${API_BASE}/anime/releases/latest?limit=2`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                updateStatus('api-status', `‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç! –ü–æ–ª—É—á–µ–Ω–æ —Ä–µ–ª–∏–∑–æ–≤: ${data.length}`, 'success');
                updateInfo('api-info', data);
                
                if (data.length > 0) {
                    currentVideoData = data[0];
                    updateTechInfo();
                }
                
            } catch (error) {
                updateStatus('api-status', `‚ùå –û—à–∏–±–∫–∞ API: ${error.message}`, 'error');
                console.error('API Error:', error);
            }
        }
        
        async function loadVideo() {
            if (!currentVideoData) {
                updateStatus('api-status', '‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç API', 'error');
                return;
            }
            
            updateStatus('api-status', '–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...', 'loading');
            
            try {
                const episode = currentVideoData.latest_episode;
                if (!episode) {
                    throw new Error('–≠–ø–∏–∑–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                const videoUrls = {
                    '480p': episode.hls_480,
                    '720p': episode.hls_720,
                    '1080p': episode.hls_1080
                };
                
                const availableUrls = Object.entries(videoUrls).filter(([quality, url]) => url);
                
                if (availableUrls.length === 0) {
                    throw new Error('–í–∏–¥–µ–æ URL –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                }
                
                updateStatus('api-status', `‚úÖ –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ! –î–æ—Å—Ç—É–ø–Ω–æ –∫–∞—á–µ—Å—Ç–≤: ${availableUrls.length}`, 'success');
                updateInfo('video-info', {
                    title: currentVideoData.name.main,
                    episode: episode.ordinal,
                    duration: episode.duration,
                    qualities: availableUrls.map(([quality, url]) => quality),
                    selectedUrl: availableUrls[0][1] // 480p –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –¥–ª—è HLS –ø–ª–µ–µ—Ä–∞
                window.videoUrl = availableUrls[0][1];
                
            } catch (error) {
                updateStatus('api-status', `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ: ${error.message}`, 'error');
                console.error('Video Error:', error);
            }
        }
        
        function testHLS() {
            if (!window.videoUrl) {
                updateStatus('api-status', '‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∏–¥–µ–æ', 'error');
                return;
            }
            
            updateStatus('api-status', '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è HLS –ø–ª–µ–µ—Ä–∞...', 'loading');
            
            const video = document.getElementById('video');
            
            if (Hls.isSupported()) {
                if (hls) {
                    hls.destroy();
                }
                
                hls = new Hls({
                    debug: true,
                    enableWorker: true,
                    lowLatencyMode: false,
                    backBufferLength: 90,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 600
                });
                
                hls.loadSource(window.videoUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function(event, data) {
                    console.log('Manifest parsed:', data);
                    updateStatus('api-status', '‚úÖ HLS –º–∞–Ω–∏—Ñ–µ—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω! –ü–ª–µ–µ—Ä –≥–æ—Ç–æ–≤.', 'success');
                    
                    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—á–µ—Å—Ç–≤–∞—Ö
                    const levels = hls.levels.map(level => ({
                        width: level.width,
                        height: level.height,
                        bitrate: Math.round(level.bitrate / 1000) + 'k'
                    }));
                    
                    updateInfo('video-info', {
                        hlsLevels: levels,
                        isLive: data.live,
                        duration: video.duration
                    });
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS Error:', data);
                    updateStatus('api-status', `‚ùå –û—à–∏–±–∫–∞ HLS: ${data.details}`, 'error');
                });
                
                hls.on(Hls.Events.LEVEL_SWITCHED, function(event, data) {
                    const level = hls.levels[data.level];
                    console.log('Quality switched to:', level.height + 'p');
                });
                
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // –ù–∞—Ç–∏–≤–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ HLS (Safari)
                video.src = window.videoUrl;
                updateStatus('api-status', '‚úÖ –ò—Å–ø–æ–ª—å–∑—É—é –Ω–∞—Ç–∏–≤–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É HLS (Safari)', 'success');
            } else {
                updateStatus('api-status', '‚ùå HLS –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'error');
            }
        }
        
        function updateTechInfo() {
            const info = {
                userAgent: navigator.userAgent,
                hlsSupported: Hls.isSupported(),
                nativeHlsSupported: document.createElement('video').canPlayType('application/vnd.apple.mpegurl') !== '',
                mseSupported: 'MediaSource' in window,
                currentTime: new Date().toISOString(),
                apiEndpoint: API_BASE
            };
            
            updateInfo('tech-info', info);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            updateTechInfo();
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç API
            testAPI();
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤–∏–¥–µ–æ
        document.getElementById('video').addEventListener('loadeddata', function() {
            console.log('Video data loaded');
        });
        
        document.getElementById('video').addEventListener('error', function(e) {
            console.error('Video error:', e);
            updateStatus('api-status', '‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ', 'error');
        });
    </script>
</body>
</html>